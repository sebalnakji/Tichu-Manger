{% extends "base.html" %}

{% block title %}ì ìˆ˜íŒ - Tichu Manager{% endblock %}

{% block content %}
<style>
    :root {
        --bg-main: #F4F4F8;
        --bg-card: #FFFFFF;
        --bg-card-hover: #F8F8FC;
        --bg-card-sub: #F0F0F6;
        --border: rgba(0, 0, 0, 0.07);
        --text-primary: #0F0F1A;
        --text-secondary: #6B7280;
        --text-muted: #9CA3AF;
        --text-label: #A0A0B0;
        --accent: #4F46E5;
        --accent-hover: #4338CA;
        --accent-shadow: rgba(79, 70, 229, 0.25);
        --accent-light: rgba(79, 70, 229, 0.08);
        --divider: rgba(0,0,0,0.06);

        --team-a-text: #3730A3;
        --team-a-score: #4F46E5;
        --team-a-bg: rgba(79, 70, 229, 0.05);
        --team-a-badge-bg: rgba(79, 70, 229, 0.1);
        --team-a-badge-text: #4F46E5;
        --team-a-rate-border: rgba(79, 70, 229, 0.2);

        --team-b-text: #9F1239;
        --team-b-score: #F43F5E;
        --team-b-bg: rgba(244, 63, 94, 0.05);
        --team-b-badge-bg: rgba(244, 63, 94, 0.1);
        --team-b-badge-text: #F43F5E;
        --team-b-rate-border: rgba(244, 63, 94, 0.2);

        --modal-bg: #FFFFFF;
        --modal-inner-bg: #F4F4F8;
        --modal-footer-bg: #F4F4F8;
        --modal-border: rgba(0,0,0,0.07);

        --round-card-bg: #FFFFFF;
        --round-card-border: rgba(0,0,0,0.07);
        --round-empty-bg: rgba(0,0,0,0.02);
        --round-empty-border: rgba(0,0,0,0.1);

        --event-card-bg: #F8F8FC;
        --event-card-border: rgba(0,0,0,0.07);

        --input-bg: rgba(79, 70, 229, 0.05);
        --input-border: rgba(79, 70, 229, 0.15);
        --input-bg-b: rgba(244, 63, 94, 0.05);
        --input-border-b: rgba(244, 63, 94, 0.15);

        --bottom-grad-from: #F4F4F8;
        --scrollbar-color: #D1D5DB;

        --victory-bg: #FFFFFF;
        --victory-top: rgba(253, 224, 71, 0.1);
    }

    [data-theme="dark"] {
        --bg-main: #0F0F1A;
        --bg-card: #1A1A2E;
        --bg-card-hover: #212136;
        --bg-card-sub: #0F0F1A;
        --border: rgba(255, 255, 255, 0.08);
        --text-primary: #FFFFFF;
        --text-secondary: #9CA3AF;
        --text-muted: #6B7280;
        --text-label: #6B7280;
        --accent: #6366F1;
        --accent-hover: #4F46E5;
        --accent-shadow: rgba(99, 102, 241, 0.3);
        --accent-light: rgba(99, 102, 241, 0.15);
        --divider: rgba(255,255,255,0.05);

        --team-a-text: #A5B4FC;
        --team-a-score: #818CF8;
        --team-a-bg: rgba(99, 102, 241, 0.08);
        --team-a-badge-bg: rgba(99, 102, 241, 0.2);
        --team-a-badge-text: #818CF8;
        --team-a-rate-border: rgba(99, 102, 241, 0.3);

        --team-b-text: #FDA4AF;
        --team-b-score: #FB7185;
        --team-b-bg: rgba(251, 113, 133, 0.08);
        --team-b-badge-bg: rgba(251, 113, 133, 0.2);
        --team-b-badge-text: #FB7185;
        --team-b-rate-border: rgba(251, 113, 133, 0.3);

        --modal-bg: #1A1A2E;
        --modal-inner-bg: #0F0F1A;
        --modal-footer-bg: #0F0F1A;
        --modal-border: rgba(255,255,255,0.08);

        --round-card-bg: #1A1A2E;
        --round-card-border: rgba(255,255,255,0.08);
        --round-empty-bg: rgba(255,255,255,0.02);
        --round-empty-border: rgba(255,255,255,0.1);

        --event-card-bg: #0F0F1A;
        --event-card-border: rgba(255,255,255,0.08);

        --input-bg: rgba(99, 102, 241, 0.1);
        --input-border: rgba(99, 102, 241, 0.3);
        --input-bg-b: rgba(251, 113, 133, 0.1);
        --input-border-b: rgba(251, 113, 133, 0.3);

        --bottom-grad-from: #0F0F1A;
        --scrollbar-color: #374151;

        --victory-bg: #1A1A2E;
        --victory-top: rgba(253, 224, 71, 0.05);
    }

    .page-bg { background-color: var(--bg-main); }

    .sb-header { background-color: var(--bg-card); border-bottom: 1px solid var(--border); }
    .sb-title { color: var(--text-primary); }
    .sb-back { color: var(--text-secondary); }
    .sb-back:hover { background-color: var(--bg-card-sub); }
    .sb-exit-btn {
        color: var(--text-muted);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        font-size: 0.75rem;
        font-weight: 700;
        padding: 0.375rem 0.75rem;
        transition: all 0.15s;
    }
    .sb-exit-btn:hover { background-color: rgba(244,63,94,0.05); color: #F43F5E; border-color: rgba(244,63,94,0.3); }

    /* ê°„ëµí™”ëœ ì ìˆ˜íŒ ì¹´ë“œ */
    .score-card {
        background-color: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 1.25rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    .score-side-a { background: linear-gradient(to bottom, var(--team-a-bg), transparent); }
    .score-side-b { background: linear-gradient(to bottom, var(--team-b-bg), transparent); }
    .score-divider { background-color: var(--divider); }
    .team-a-label { color: var(--team-a-text); }
    .team-b-label { color: var(--team-b-text); }
    .team-a-score-val { color: var(--team-a-score); }
    .team-b-score-val { color: var(--team-b-score); }
    .season-rate-a { color: var(--team-a-badge-text); background-color: var(--team-a-badge-bg); }
    .season-rate-b { color: var(--team-b-badge-text); background-color: var(--team-b-badge-bg); }
    .session-record { color: var(--text-secondary); }

    /* ë¼ìš´ë“œ ì¹´ë“œ */
    .section-label { color: var(--text-muted); }
    .round-card {
        background-color: var(--round-card-bg);
        border: 1px solid var(--round-card-border);
        border-radius: 1rem;
        padding: 0.625rem 0.875rem;
        cursor: pointer;
        transition: background-color 0.15s;
    }
    .round-card:hover { background-color: var(--bg-card-sub); }
    .round-label { color: var(--text-muted); }
    .round-score-a { color: var(--team-a-score); }
    .round-score-b { color: var(--team-b-score); }
    .round-empty {
        background-color: var(--round-empty-bg);
        border: 1px dashed var(--round-empty-border);
        border-radius: 1rem;
        color: var(--text-muted);
    }

    .bottom-grad { background: linear-gradient(to top, var(--bottom-grad-from) 60%, transparent); }
    .add-round-btn {
        background-color: #10B981;
        color: white;
        border-radius: 1rem;
        box-shadow: 0 4px 16px rgba(16,185,129,0.3);
        transition: background-color 0.2s, transform 0.15s;
    }
    .add-round-btn:hover { background-color: #059669; }
    .add-round-btn:active { transform: scale(0.98); }
    .add-round-icon {
        background-color: rgba(255,255,255,0.15);
        border-radius: 9999px;
        width: 2rem; height: 2rem;
        display: flex; align-items: center; justify-content: center;
    }

    .round-modal-wrap { background-color: var(--modal-bg); }
    .round-modal-header { border-bottom: 1px solid var(--modal-border); }
    .round-modal-title { color: var(--text-primary); }
    .round-modal-close { color: var(--text-muted); }
    .score-label-a { color: var(--team-a-badge-text); }
    .score-label-b { color: var(--team-b-badge-text); }
    .score-member-a { color: var(--team-a-score); }
    .score-member-b { color: var(--team-b-score); }
    .score-input-a {
        background-color: var(--input-bg);
        border: 2px solid var(--input-border);
        border-radius: 1rem;
        padding: 1rem 0.5rem;
        text-align: center;
        font-size: 1.875rem;
        font-weight: 900;
        color: var(--team-a-text);
        width: 100%;
        outline: none;
        transition: border-color 0.15s;
    }
    .score-input-a:focus { border-color: var(--team-a-score); }
    .score-input-b {
        background-color: var(--input-bg-b);
        border: 2px solid var(--input-border-b);
        border-radius: 1rem;
        padding: 1rem 0.5rem;
        text-align: center;
        font-size: 1.875rem;
        font-weight: 900;
        color: var(--team-b-text);
        width: 100%;
        outline: none;
        transition: border-color 0.15s;
    }
    .score-input-b:focus { border-color: var(--team-b-score); }
    .score-slash { color: var(--text-muted); }
    .section-title { color: var(--text-muted); }
    .event-btn-tichu { background-color: var(--bg-card); border: 2px solid rgba(234,179,8,0.2); color: #A16207; font-weight: 900; border-radius: 0.75rem; padding: 0.75rem; transition: background-color 0.15s; }
    .event-btn-grand { background-color: var(--bg-card); border: 2px solid rgba(147,51,234,0.2); color: #7E22CE; font-weight: 900; border-radius: 0.75rem; padding: 0.75rem; transition: background-color 0.15s; }
    .event-btn-onetwo { background-color: var(--bg-card); border: 2px solid rgba(16,185,129,0.2); color: #065F46; font-weight: 900; border-radius: 0.75rem; padding: 0.75rem; transition: background-color 0.15s; }
    .event-card { background-color: var(--event-card-bg); border: 1px solid var(--event-card-border); border-radius: 0.75rem; padding: 0.75rem; }
    .event-empty { color: var(--text-muted); border: 1px dashed var(--round-empty-border); border-radius: 0.75rem; }
    .event-delete { color: var(--text-muted); font-size: 0.75rem; font-weight: 700; }
    .event-delete:hover { color: #F43F5E; }
    .event-toggle-default { background-color: var(--bg-card); color: var(--text-primary); }
    .modal-footer { background-color: var(--modal-footer-bg); border-top: 1px solid var(--modal-border); }
    .preview-a { color: var(--team-a-score); font-weight: 700; }
    .preview-b { color: var(--team-b-score); font-weight: 700; }
    .delete-btn { background-color: var(--bg-card-sub); color: var(--text-muted); border-radius: 0.75rem; font-weight: 700; padding: 1rem; transition: all 0.15s; }
    .delete-btn:hover { background-color: rgba(244,63,94,0.1); color: #F43F5E; }
    .save-btn { background-color: #10B981; color: white; border-radius: 0.75rem; font-weight: 700; padding: 1rem; flex: 1; box-shadow: 0 4px 12px rgba(16,185,129,0.3); transition: background-color 0.2s, transform 0.15s; }
    .save-btn:hover { background-color: #059669; }
    .save-btn:active { transform: scale(0.98); }

    .victory-modal-wrap { background-color: var(--victory-bg); }
    .victory-top { background: linear-gradient(to bottom, var(--victory-top), transparent); }
    .victory-title { color: var(--text-primary); }
    .victory-inner { background-color: var(--bg-card); border: 2px solid rgba(234,179,8,0.15); border-radius: 1rem; }
    .victory-divider { border-color: var(--divider); }
    .victory-sub { color: var(--text-muted); }
    .victory-record { color: var(--text-primary); }
    .victory-btn-main { background-color: #10B981; color: white; border-radius: 0.75rem; font-weight: 700; padding: 0.875rem; width: 100%; transition: background-color 0.2s; }
    .victory-btn-main:hover { background-color: #059669; }
    .victory-btn-sub { background-color: var(--bg-card-sub); color: var(--text-secondary); border-radius: 0.75rem; font-weight: 700; padding: 0.875rem; flex: 1; transition: background-color 0.15s; }
    .victory-btn-sub:hover { background-color: var(--bg-main); }

    .exit-modal-wrap { background-color: var(--modal-bg); }
    .exit-title { color: var(--text-primary); }
    .exit-desc { color: var(--text-muted); }
    .exit-btn { width: 100%; font-weight: 700; padding: 0.75rem 1rem; border-radius: 0.75rem; text-align: left; display: flex; align-items: center; gap: 0.75rem; transition: background-color 0.15s; }
    .exit-cancel { color: var(--text-muted); font-weight: 700; padding: 0.75rem; width: 100%; transition: color 0.15s; }

    /* ìŠ¬ë¼ì´ë” íŠ¸ë™ ìƒ‰ìƒ */
    input[type=range]#slider-a { background: linear-gradient(to right, rgba(79,70,229,0.35) 0%, rgba(79,70,229,0.35) 50%, rgba(79,70,229,0.15) 50%, rgba(79,70,229,0.15) 100%); }
    input[type=range]#slider-b { background: linear-gradient(to right, rgba(244,63,94,0.35) 0%, rgba(244,63,94,0.35) 50%, rgba(244,63,94,0.15) 50%, rgba(244,63,94,0.15) 100%); }
    input[type=range]:disabled { opacity: 0.3; }

    /* ì…ë ¥ íŒ¨ë„ êµ¬ë¶„ ê°•ì¡° */
    #input-panel { box-shadow: 0 -4px 20px rgba(0,0,0,0.08); }
</style>

<div class="page-bg fixed inset-0 flex flex-col overflow-hidden">

    <!-- ìµœìƒë‹¨ í—¤ë” -->
    <div class="sb-header shadow-sm shrink-0">
        <div class="max-w-lg mx-auto px-4 py-3 flex items-center justify-between">
            <a href="/" class="p-2 -ml-2 rounded-full transition sb-back">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            <h2 class="text-lg font-black sb-title">ì ìˆ˜íŒ</h2>
            <button id="exit-game-btn" class="sb-exit-btn">ì¢…ë£Œ</button>
        </div>
    </div>

    <!-- ìƒë‹¨: ê³ ì • ì ìˆ˜íŒ -->
    <div class="shrink-0 max-w-lg mx-auto w-full px-4 pt-4 pb-3">
        <div class="score-card">
            <div class="flex items-stretch">
                <!-- TEAM A -->
                <div class="flex-1 px-4 py-4 flex flex-col items-center justify-center gap-1.5 score-side-a">
                    <div class="flex items-center gap-1.5">
                        <p class="text-xs font-black tracking-widest team-a-label">TEAM A</p>
                        <p class="text-xs truncate" style="color:var(--text-muted)" id="team-a-names"></p>
                    </div>
                    <p id="team-a-score" class="text-4xl font-black tracking-tighter leading-none team-a-score-val">0</p>
                    <div class="flex items-center gap-1.5">
                        <p id="team-a-session-record" class="text-xs font-bold session-record">0ìŠ¹ 0íŒ¨</p>
                        <span id="team-a-season-rate" class="text-[10px] font-bold px-2 py-0.5 rounded-full season-rate-a">ì‹œì¦Œ 0%</span>
                    </div>
                </div>
                <!-- êµ¬ë¶„ì„  + VS -->
                <div class="score-divider relative flex items-center justify-center" style="width:1px;">
                    <div class="absolute text-[10px] font-black px-1.5 py-0.5 rounded-full shadow-sm z-10" style="background-color:var(--bg-card); border:1px solid var(--border); color:var(--text-muted);">VS</div>
                </div>
                <!-- TEAM B -->
                <div class="flex-1 px-4 py-4 flex flex-col items-center justify-center gap-1.5 score-side-b">
                    <div class="flex items-center gap-1.5">
                        <p class="text-xs font-black tracking-widest team-b-label">TEAM B</p>
                        <p class="text-xs truncate" style="color:var(--text-muted)" id="team-b-names"></p>
                    </div>
                    <p id="team-b-score" class="text-4xl font-black tracking-tighter leading-none team-b-score-val">0</p>
                    <div class="flex items-center gap-1.5">
                        <p id="team-b-session-record" class="text-xs font-bold session-record">0ìŠ¹ 0íŒ¨</p>
                        <span id="team-b-season-rate" class="text-[10px] font-bold px-2 py-0.5 rounded-full season-rate-b">ì‹œì¦Œ 0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì¤‘ë‹¨: ë¼ìš´ë“œ ê¸°ë¡ (ìŠ¤í¬ë¡¤) -->
    <div class="flex-1 overflow-y-auto max-w-lg mx-auto w-full px-4">
        <h3 class="text-xs font-bold uppercase tracking-wider mb-3 px-1 section-label">ë¼ìš´ë“œ ê¸°ë¡</h3>
        <div id="rounds-container" class="space-y-3 pb-6"></div>
    </div>

    <!-- í•˜ë‹¨ ì ìˆ˜ ì…ë ¥ íŒ¨ë„ -->
    <div id="input-panel" class="shrink-0 max-w-lg mx-auto w-full" style="background-color:var(--bg-main); border-top: 2px solid var(--border);">

        <!-- íƒœê·¸ ì˜ì—­ -->
        <div id="event-tags" class="hidden px-4 pt-2 flex flex-wrap gap-1"></div>

        <div class="px-4 pt-3 pb-safe" style="background-color:var(--bg-main);">
            <!-- ì ìˆ˜ ìŠ¬ë¼ì´ë” -->
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] font-black" style="color:var(--team-a-score)">TEAM A</span>
                        <span id="slider-a-val" class="text-sm font-black" style="color:var(--team-a-score)">50</span>
                    </div>
                    <input type="range" id="slider-a" min="-25" max="125" step="5" value="50"
                        class="w-full h-2 rounded-full appearance-none cursor-pointer"
                        style="accent-color:var(--team-a-score);"
                        oninput="onSliderA()">
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] font-black" style="color:var(--team-b-score)">TEAM B</span>
                        <span id="slider-b-val" class="text-sm font-black" style="color:var(--team-b-score)">50</span>
                    </div>
                    <input type="range" id="slider-b" min="-25" max="125" step="5" value="50"
                        class="w-full h-2 rounded-full appearance-none cursor-pointer"
                        style="accent-color:var(--team-b-score);"
                        oninput="onSliderB()">
                </div>
            </div>

            <!-- ì´ë²¤íŠ¸ ë²„íŠ¼ ê·¸ë¦¬ë“œ -->
            <div id="event-btn-grid" class="mb-3"></div>

            <!-- ì´ˆê¸°í™” / ì €ì¥ -->
            <div class="flex gap-2 pb-4">
                <button onclick="resetInput()" class="flex-none text-sm font-bold py-3 px-4 rounded-xl transition" style="background-color:var(--bg-card-sub); color:var(--text-muted);">ì´ˆê¸°í™”</button>
                <button onclick="saveRound()" class="flex-1 text-sm font-bold py-3 rounded-xl text-white transition" style="background-color:#10B981; box-shadow:0 4px 12px rgba(16,185,129,0.3);">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    </div>
</div>

<!-- ìŠ¹ë¦¬ ëª¨ë‹¬ -->
<div id="victory-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-md px-4">
    <div class="victory-modal-wrap rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden relative p-8 text-center">
        <div class="absolute inset-0 victory-top pointer-events-none"></div>
        <div class="relative">
            <div class="text-6xl mb-4">ğŸ‘‘</div>
            <h3 class="text-2xl font-black mb-1 victory-title">WINNER!</h3>
            <p class="text-lg font-bold mb-6" style="color: var(--accent);" id="victory-winner-text"></p>
            <div class="victory-inner p-6 mb-6 shadow-sm">
                <div class="flex justify-center items-center gap-6">
                    <div>
                        <p class="text-xs font-bold victory-sub">TEAM A</p>
                        <p class="text-3xl font-black team-a-score-val" id="victory-score-a"></p>
                    </div>
                    <div class="text-2xl font-light score-slash">/</div>
                    <div>
                        <p class="text-xs font-bold victory-sub">TEAM B</p>
                        <p class="text-3xl font-black team-b-score-val" id="victory-score-b"></p>
                    </div>
                </div>
                <div class="mt-4 pt-4 victory-divider" style="border-top: 1px solid var(--divider);">
                    <p class="text-xs mb-1 victory-sub">í˜„ì¬ ë°© ì „ì </p>
                    <p class="font-bold victory-record">
                        <span class="team-a-score-val" id="victory-team-a-wins">0</span>ìŠ¹
                        <span class="team-b-score-val" id="victory-team-b-wins">0</span>íŒ¨
                    </p>
                </div>
            </div>
            <div class="space-y-3">
                <button onclick="rematch()" class="victory-btn-main">ğŸ”„ ì¬ëŒ€ê²° (íŒ€ ìœ ì§€)</button>
                <div class="flex gap-3">
                    <button onclick="closeVictoryModal()" class="victory-btn-sub">ìˆ˜ì •</button>
                    <button onclick="goHome()" class="victory-btn-sub">í™ˆ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì¢…ë£Œ ëª¨ë‹¬ -->
<div id="exit-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm px-4">
    <div class="exit-modal-wrap rounded-3xl p-6 w-full max-w-sm shadow-2xl">
        <h3 class="text-xl font-black mb-2 exit-title">ê²Œì„ ì¢…ë£Œ</h3>
        <p class="text-sm mb-6 exit-desc">ì§„í–‰ ì¤‘ì¸ ê²Œì„ì„ ì¢…ë£Œí•˜ê³  ì–´ë””ë¡œ ê°ˆê¹Œìš”?</p>
        <div class="space-y-3">
            <button onclick="goHome()" class="exit-btn" style="background-color: var(--accent-light); color: var(--accent);">
                <span>ğŸ </span> ì €ì¥ í›„ í™ˆìœ¼ë¡œ
            </button>
            <button onclick="resetAndContinue()" class="exit-btn" style="background-color: rgba(249,115,22,0.08); color: #C2410C;">
                <span>ğŸ”„</span> ì ìˆ˜ ì´ˆê¸°í™” (íŒ€ ìœ ì§€)
            </button>
            <button onclick="goToTeamSelection()" class="exit-btn" style="background-color: rgba(147,51,234,0.08); color: #7E22CE;">
                <span>ğŸ‘¥</span> ìƒˆ íŒ€ ì§œê¸°
            </button>
            <button onclick="closeExitModal()" class="exit-cancel">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    const matchId = {{ match_id }};
    let matchData = null;
    let currentRoundNumber = null;
    let events = [];
    const SESSION_KEY = 'tichu_current_session_stats';

    document.addEventListener('DOMContentLoaded', () => {
        initSessionStats();
        loadMatchData();
        document.getElementById('exit-game-btn').addEventListener('click', showExitModal);
    });

    function initSessionStats() {
        if (document.referrer.includes('team-selection')) sessionStorage.removeItem(SESSION_KEY);
        let stats = JSON.parse(sessionStorage.getItem(SESSION_KEY));
        if (!stats) { stats = { team_a_wins: 0, team_b_wins: 0, total_games: 0 }; sessionStorage.setItem(SESSION_KEY, JSON.stringify(stats)); }
    }

    async function loadMatchData() {
        try {
            const response = await fetch(`/api/matches/${matchId}`);
            matchData = await response.json();
            renderTeamInfo();
            renderRounds();
            initInputPanel();
            renderEventBtnGrid();
        } catch (error) { console.error('Error:', error); }
    }

    function renderTeamInfo() {
        document.getElementById('team-a-score').textContent = matchData.team_a_total_score;
        document.getElementById('team-b-score').textContent = matchData.team_b_total_score;
        document.getElementById('team-a-names').textContent = matchData.team_a_players.map(p => p.name).join(' Â· ');
        document.getElementById('team-b-names').textContent = matchData.team_b_players.map(p => p.name).join(' Â· ');
        const stats = JSON.parse(sessionStorage.getItem(SESSION_KEY));
        document.getElementById('team-a-session-record').textContent = `${stats.team_a_wins}ìŠ¹ ${stats.team_b_wins}íŒ¨`;
        document.getElementById('team-b-session-record').textContent = `${stats.team_b_wins}ìŠ¹ ${stats.team_a_wins}íŒ¨`;
        const aRate = matchData.team_a_team_win_rate ?? 0;
        const bRate = matchData.team_b_team_win_rate ?? 0;
        document.getElementById('team-a-season-rate').textContent = `ì‹œì¦Œ ${aRate}%`;
        document.getElementById('team-b-season-rate').textContent = `ì‹œì¦Œ ${bRate}%`;
    }

    // â”€â”€ ì…ë ¥ íŒ¨ë„ ì´ˆê¸°í™” â”€â”€
    function initInputPanel() {
        currentRoundNumber = matchData.rounds.length > 0 ? Math.max(...matchData.rounds.map(r => r.round_number)) + 1 : 1;
        events = [];
        setSliders(50, 50, false);
        renderEventBtnGrid();
        renderTags();
    }

    function loadRoundToPanel(n) {
        currentRoundNumber = n;
        const round = matchData.rounds.find(r => r.round_number === n);
        events = JSON.parse(JSON.stringify(round.events)).map(e => {
            // key ì¬êµ¬ì„±
            if (e.type === 'one_two') e.key = `ot-${e.team}`;
            else {
                const teamPrefix = matchData.team_a_ids.includes(e.player_id) ? 'a' : 'b';
                const typeStr = e.type === 'tichu' ? 'tichu' : 'grand';
                const successStr = e.success ? 's' : 'f';
                e.key = `${teamPrefix}-${e.player_id}-${typeStr}-${successStr}`;
            }
            return e;
        });
        const hasOT = events.some(e => e.type === 'one_two');
        setSliders(round.team_a_base_score, round.team_b_base_score, hasOT);
        renderEventBtnGrid();
        renderTags();
    }

    function setSliders(a, b, disabled) {
        const sa = document.getElementById('slider-a'), sb = document.getElementById('slider-b');
        sa.value = a; sb.value = b;
        sa.disabled = disabled; sb.disabled = disabled;
        sa.style.opacity = disabled ? '0.4' : '1';
        sb.style.opacity = disabled ? '0.4' : '1';
        document.getElementById('slider-a-val').textContent = a;
        document.getElementById('slider-b-val').textContent = b;
    }

    function onSliderA() {
        const a = parseInt(document.getElementById('slider-a').value);
        const b = 100 - a;
        document.getElementById('slider-b').value = Math.max(-25, Math.min(125, b));
        document.getElementById('slider-a-val').textContent = a;
        document.getElementById('slider-b-val').textContent = Math.max(-25, Math.min(125, b));
    }

    function onSliderB() {
        const b = parseInt(document.getElementById('slider-b').value);
        const a = 100 - b;
        document.getElementById('slider-a').value = Math.max(-25, Math.min(125, a));
        document.getElementById('slider-b-val').textContent = b;
        document.getElementById('slider-a-val').textContent = Math.max(-25, Math.min(125, a));
    }

    // â”€â”€ ì´ë²¤íŠ¸ ë²„íŠ¼ ê·¸ë¦¬ë“œ ë Œë”ë§ â”€â”€
    function renderEventBtnGrid() {
        const grid = document.getElementById('event-btn-grid');
        if (!grid || !matchData) return;

        const aPlayers = matchData.team_a_players; // 2ëª…
        const bPlayers = matchData.team_b_players; // 2ëª…

        // 2í–‰ 9ì—´ êµ¬ì¡°
        // í–‰1(ì„±ê³µ): A1 Tâœ…, A1 Lâœ…, A2 Tâœ…, A2 Lâœ…, AíŒ€ì›íˆ¬, B1 Tâœ…, B1 Lâœ…, B2 Tâœ…, B2 Lâœ…
        // í–‰2(ì‹¤íŒ¨): A1 TâŒ, A1 LâŒ, A2 TâŒ, A2 LâŒ, BíŒ€ì›íˆ¬, B1 TâŒ, B1 LâŒ, B2 TâŒ, B2 LâŒ

        const mkKey = (team, pid, type, suf) => `${team}-${pid}-${type}-${suf}`;
        const shortName = p => p.name.slice(-2);

        const row1 = [
            ...aPlayers.flatMap(p => [
                { key: mkKey('a',p.id,'tichu','s'), label:`${shortName(p)} T`, type:'tichu', player_id:p.id, success:true,  team:null, success_icon:'âœ…', textColor:'#92400E', activeBg:'#FEF3C7', borderColor:'rgba(234,179,8,0.5)' },
                { key: mkKey('a',p.id,'grand','s'), label:`${shortName(p)} L`, type:'grand', player_id:p.id, success:true,  team:null, success_icon:'âœ…', textColor:'#6D28D9', activeBg:'#EDE9FE', borderColor:'rgba(139,92,246,0.5)' },
            ]),
            { key:'ot-A', label:'AíŒ€\nì›íˆ¬', type:'one_two', player_id:null, success:null, team:'A', success_icon:'', textColor:'#4F46E5', activeBg:'#D1FAE5', borderColor:'rgba(16,185,129,0.5)' },
            ...bPlayers.flatMap(p => [
                { key: mkKey('b',p.id,'tichu','s'), label:`${shortName(p)} T`, type:'tichu', player_id:p.id, success:true,  team:null, success_icon:'âœ…', textColor:'#92400E', activeBg:'#FEF3C7', borderColor:'rgba(234,179,8,0.5)' },
                { key: mkKey('b',p.id,'grand','s'), label:`${shortName(p)} L`, type:'grand', player_id:p.id, success:true,  team:null, success_icon:'âœ…', textColor:'#6D28D9', activeBg:'#EDE9FE', borderColor:'rgba(139,92,246,0.5)' },
            ]),
        ];

        const row2 = [
            ...aPlayers.flatMap(p => [
                { key: mkKey('a',p.id,'tichu','f'), label:`${shortName(p)} T`, type:'tichu', player_id:p.id, success:false, team:null, success_icon:'âŒ', textColor:'#991B1B', activeBg:'#FEE2E2', borderColor:'rgba(234,179,8,0.5)' },
                { key: mkKey('a',p.id,'grand','f'), label:`${shortName(p)} L`, type:'grand', player_id:p.id, success:false, team:null, success_icon:'âŒ', textColor:'#991B1B', activeBg:'#FEE2E2', borderColor:'rgba(139,92,246,0.5)' },
            ]),
            { key:'ot-B', label:'BíŒ€\nì›íˆ¬', type:'one_two', player_id:null, success:null, team:'B', success_icon:'', textColor:'#F43F5E', activeBg:'#D1FAE5', borderColor:'rgba(16,185,129,0.5)' },
            ...bPlayers.flatMap(p => [
                { key: mkKey('b',p.id,'tichu','f'), label:`${shortName(p)} T`, type:'tichu', player_id:p.id, success:false, team:null, success_icon:'âŒ', textColor:'#991B1B', activeBg:'#FEE2E2', borderColor:'rgba(234,179,8,0.5)' },
                { key: mkKey('b',p.id,'grand','f'), label:`${shortName(p)} L`, type:'grand', player_id:p.id, success:false, team:null, success_icon:'âŒ', textColor:'#991B1B', activeBg:'#FEE2E2', borderColor:'rgba(139,92,246,0.5)' },
            ]),
        ];

        grid.innerHTML = '';
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(9, 1fr)';
        grid.style.gridTemplateRows = 'repeat(2, auto)';
        grid.style.gap = '4px';

        [...row1, ...row2].forEach(def => {
            const isActive = events.some(e => e.key === def.key);
            const btn = document.createElement('button');
            btn.id = `evbtn-${def.key}`;
            btn.className = 'text-[10px] font-bold py-1.5 rounded-lg border-2 transition leading-tight';
            btn.style.cssText = isActive
                ? `background-color:${def.activeBg}; color:${def.textColor}; border-color:${def.borderColor};`
                : `background-color:var(--bg-card); color:${def.textColor}; border-color:${def.borderColor};`;
            btn.innerHTML = def.success_icon
                ? `${def.label}<br><span>${def.success_icon}</span>`
                : def.label.replace('\n','<br>');
            btn.onclick = () => toggleEvent(def);
            grid.appendChild(btn);
        });
    }

    function toggleEvent(def) {
        const idx = events.findIndex(e => e.key === def.key);
        if (idx !== -1) {
            // ì´ë¯¸ ìˆìœ¼ë©´ ì œê±°
            const type = events[idx].type;
            events.splice(idx, 1);
            if (type === 'one_two' && !events.some(e => e.type === 'one_two')) setSliders(50, 50, false);
        } else {
            // ì›íˆ¬ë©´ ê¸°ì¡´ ì›íˆ¬ ì œê±° í›„ ì¶”ê°€
            if (def.type === 'one_two') {
                events = events.filter(e => e.type !== 'one_two');
                setSliders(0, 0, true);
            }
            events.push({ key: def.key, type: def.type, player_id: def.player_id, success: def.success, team: def.team });
        }
        renderEventBtnGrid();
        renderTags();
    }

    function renderTags() {
        const container = document.getElementById('event-tags');
        if (events.length === 0) { container.classList.add('hidden'); container.innerHTML = ''; return; }
        container.classList.remove('hidden');
        container.innerHTML = '';
        events.forEach((e, i) => {
            const p = [...(matchData?.team_a_players || []), ...(matchData?.team_b_players || [])].find(x => x.id === e.player_id);
            let text = e.type === 'one_two' ? `${e.team === 'A' ? 'AíŒ€' : 'BíŒ€'} ì›íˆ¬`
                : `${p ? p.name : ''} ${e.type === 'tichu' ? 'T' : 'L'} ${e.success ? 'âœ…' : 'âŒ'}`;
            let bg, color;
            if (e.type === 'one_two' && e.team === 'A') { bg = '#CCFBF1'; color = '#065F46'; }
            else if (e.type === 'one_two' && e.team === 'B') { bg = '#FEF2F2'; color = '#7F1D1D'; }
            else if (e.type === 'tichu' && e.success) { bg = '#FEF3C7'; color = '#92400E'; }
            else if (e.type === 'grand' && e.success) { bg = '#EDE9FE'; color = '#6D28D9'; }
            else { bg = '#FEE2E2'; color = '#991B1B'; }
            const tag = document.createElement('span');
            tag.className = 'text-xs font-bold px-2 py-0.5 rounded-lg flex items-center gap-1 cursor-pointer active:scale-95 transition';
            tag.style.cssText = `background-color:${bg}; color:${color};`;
            tag.onclick = () => removeEventByIndex(i);
            tag.innerHTML = `${text} <span style="opacity:0.6; font-size:0.75rem; line-height:1;">âœ•</span>`;
            container.appendChild(tag);
        });
    }

    function removeEventByIndex(i) {
        const type = events[i].type;
        events.splice(i, 1);
        if (type === 'one_two' && !events.some(e => e.type === 'one_two')) setSliders(50, 50, false);
        renderEventBtnGrid();
        renderTags();
    }

    function renderRounds() {
        const container = document.getElementById('rounds-container');
        container.innerHTML = '';
        if (matchData.rounds.length === 0) {
            container.innerHTML = '<div class="round-empty w-full text-center text-sm py-8">ê¸°ë¡ëœ ë¼ìš´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        [...matchData.rounds].sort((a, b) => b.round_number - a.round_number).forEach(round => {
            const div = document.createElement('div');
            div.className = 'round-card';
            let eventBadges = '';
            round.events.forEach(e => {
                const p = [...matchData.team_a_players, ...matchData.team_b_players].find(x => x.id === e.player_id);
                let badgeClass;
                if (e.type === 'one_two') badgeClass = 'bg-emerald-100 text-emerald-700';
                else if (e.type === 'tichu' && e.success) badgeClass = 'bg-yellow-100 text-yellow-700';
                else if (e.type === 'grand' && e.success) badgeClass = 'bg-violet-100 text-violet-700';
                else badgeClass = 'bg-red-100 text-red-700';
                let text = e.type === 'one_two' ? `${e.team === 'A' ? 'AíŒ€' : 'BíŒ€'} ì›íˆ¬` : `${p ? p.name : ''} ${e.type === 'tichu' ? 'í‹°ì¸„' : 'ë¼ì§€'} ${e.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`;
                eventBadges += `<span class="text-xs font-bold px-2 py-0.5 rounded-lg ${badgeClass}">${text}</span>`;
            });
            div.innerHTML = `
                <div class="relative">
                    <span class="text-xs font-bold round-label">ROUND ${round.round_number}</span>
                    <button onclick="loadRoundToPanel(${round.round_number})" class="absolute right-0 top-0 text-[10px] font-bold px-2 py-0.5 rounded-full transition" style="background-color:var(--bg-card-sub); color:var(--text-muted);">ìˆ˜ì •</button>
                    <div class="flex justify-center items-center gap-3 -mt-4">
                        <span class="text-2xl font-black round-score-a">${round.team_a_total}</span>
                        <span style="color:var(--text-muted); font-size:0.75rem;">vs</span>
                        <span class="text-2xl font-black round-score-b">${round.team_b_total}</span>
                    </div>
                </div>
                ${eventBadges ? `<div class="flex flex-wrap gap-1 mt-1">${eventBadges}</div>` : ''}`;
            container.appendChild(div);
        });
    }

    function removeEvent(i) { removeEventByIndex(i); }

    function resetInput() {
        events = [];
        currentRoundNumber = matchData.rounds.length > 0 ? Math.max(...matchData.rounds.map(r => r.round_number)) + 1 : 1;
        setSliders(50, 50, false);
        renderEventBtnGrid();
        renderTags();
    }

    async function saveRound() {
        const hasOT = events.some(e => e.type === 'one_two');
        const teamABase = hasOT ? 0 : parseInt(document.getElementById('slider-a').value);
        const teamBBase = hasOT ? 0 : parseInt(document.getElementById('slider-b').value);
        if (!hasOT && teamABase + teamBBase !== 100) { alert("ê¸°ë³¸ ì ìˆ˜ í•©ê³„ê°€ 100ì ì´ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

        for (const e of events) {
            if (e.type === 'one_two' && !e.team) { alert("ì›íˆ¬ì˜ íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            if (e.type !== 'one_two' && !e.player_id) { alert(`${e.type === 'tichu' ? 'í‹°ì¸„' : 'ë¼ì§€'}ì˜ í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.`); return; }
        }

        // ê°™ì€ í”Œë ˆì´ì–´ ì¤‘ë³µ ì´ë²¤íŠ¸ ë§‰ê¸°
        const playerEvents = events.filter(e => e.type !== 'one_two' && e.player_id);
        const playerIds = playerEvents.map(e => e.player_id);
        const duplicateId = playerIds.find((id, i) => playerIds.indexOf(id) !== i);
        if (duplicateId) {
            const p = [...matchData.team_a_players, ...matchData.team_b_players].find(x => x.id === duplicateId);
            alert(`${p ? p.name : ''} ë‹˜ì´ ì¤‘ë³µ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`); return;
        }

        // í‹°ì¸„/ë¼ì§€ ì„±ê³µ 2ëª… ì´ìƒ ë§‰ê¸°
        const successEvents = events.filter(e => e.type !== 'one_two' && e.success === true);
        if (successEvents.length > 1) { alert("í‹°ì¸„/ë¼ì§€ ì„±ê³µì€ ë¼ìš´ë“œë‹¹ 1ëª…ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }

        // ì›íˆ¬ íŒ€ + ìƒëŒ€íŒ€ í‹°ì¸„/ë¼ì§€ ì„±ê³µ ë§‰ê¸°
        const otEvent = events.find(e => e.type === 'one_two');
        if (otEvent && successEvents.length > 0) {
            const successPlayer = successEvents[0];
            const isTeamA = matchData.team_a_ids.includes(successPlayer.player_id);
            const successTeam = isTeamA ? 'A' : 'B';
            if (successTeam !== otEvent.team) {
                alert(`${otEvent.team === 'A' ? 'AíŒ€' : 'BíŒ€'} ì›íˆ¬ ì‹œ ìƒëŒ€íŒ€ì€ í‹°ì¸„/ë¼ì§€ë¥¼ ì„±ê³µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }
        }

        const data = { round_number: currentRoundNumber, team_a_base_score: teamABase, team_b_base_score: teamBBase, events };
        try {
            const res = await fetch(`/api/matches/${matchId}/rounds`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (!res.ok) throw new Error((await res.json()).detail);
            matchData = await res.json();
            renderTeamInfo(); renderRounds();
            initInputPanel();
            if (matchData.status === 'FINISHED') showVictoryModal();
        } catch (e) { alert(e.message); }
    }

    function showVictoryModal() {
        document.getElementById('victory-winner-text').textContent = matchData.winner_team === 'A' ? 'TEAM A ìŠ¹ë¦¬!' : 'TEAM B ìŠ¹ë¦¬!';
        document.getElementById('victory-score-a').textContent = matchData.team_a_total_score;
        document.getElementById('victory-score-b').textContent = matchData.team_b_total_score;
        const stats = JSON.parse(sessionStorage.getItem(SESSION_KEY));
        document.getElementById('victory-team-a-wins').textContent = stats.team_a_wins + (matchData.winner_team === 'A' ? 1 : 0);
        document.getElementById('victory-team-b-wins').textContent = stats.team_b_wins + (matchData.winner_team === 'B' ? 1 : 0);
        document.getElementById('victory-modal').classList.remove('hidden');
    }

    function closeVictoryModal() { document.getElementById('victory-modal').classList.add('hidden'); }

    async function rematch() {
        let stats = JSON.parse(sessionStorage.getItem(SESSION_KEY));
        if (matchData.winner_team === 'A') stats.team_a_wins++; else stats.team_b_wins++;
        stats.total_games++;
        sessionStorage.setItem(SESSION_KEY, JSON.stringify(stats));
        try {
            const res = await fetch('/api/matches/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team_a_ids: matchData.team_a_ids, team_b_ids: matchData.team_b_ids }) });
            window.location.href = `/scoreboard/${(await res.json()).id}`;
        } catch (e) { alert('ì‹¤íŒ¨'); }
    }

    function showExitModal() { document.getElementById('exit-modal').classList.remove('hidden'); }
    function closeExitModal() { document.getElementById('exit-modal').classList.add('hidden'); }

    async function resetAndContinue() {
        if (confirm('ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            await fetch(`/api/matches/${matchId}/reset`, { method: 'POST' });
            window.location.reload();
        }
    }
    function goToTeamSelection() { window.location.href = '/team-selection'; }
    function goHome() { window.location.href = '/'; }
</script>
{% endblock %}