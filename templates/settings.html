{% extends "base.html" %}

{% block title %}ì„¤ì • - Tichu Manager{% endblock %}

{% block content %}
<style>
    :root {
        --bg-main: #F9FAFB;
        --bg-card: #FFFFFF;
        --bg-card-sub: #F3F4F6;
        --border: rgba(0,0,0,0.07);
        --text-primary: #1F2937;
        --text-secondary: #6B7280;
        --text-muted: #9CA3AF;
        --accent: #10B981;
        --divider: rgba(0,0,0,0.06);
        --header-bg: rgba(255,255,255,0.95);
        --input-text: #1F2937;
        --error-bg: #FEF2F2;
        --error-text: #EF4444;
        --toggle-label: #1F2937;
        --toggle-sub: #9CA3AF;
        --toggle-card-bg: #FFFFFF;
        --admin-icon-bg: #111827;
        --tab-bg: #F3F4F6;
        --tab-active-bg: #FFFFFF;
        --tab-active-text: #1F2937;
        --tab-inactive-text: #9CA3AF;
        --user-badge-bg: #ECFDF5;
        --user-badge-text: #059669;
        --team-a-text: #3730A3;
        --team-a-score: #4F46E5;
        --team-b-text: #9F1239;
        --team-b-score: #F43F5E;
    }

    [data-theme="dark"] {
        --bg-main: #0F0F1A;
        --bg-card: #1A1A2E;
        --bg-card-sub: #0F0F1A;
        --border: rgba(255,255,255,0.08);
        --text-primary: #F9FAFB;
        --text-secondary: #9CA3AF;
        --text-muted: #6B7280;
        --accent: #10B981;
        --divider: rgba(255,255,255,0.05);
        --header-bg: rgba(26,26,46,0.95);
        --input-text: #F9FAFB;
        --error-bg: rgba(239,68,68,0.1);
        --error-text: #FCA5A5;
        --toggle-label: #F9FAFB;
        --toggle-sub: #6B7280;
        --toggle-card-bg: #1A1A2E;
        --admin-icon-bg: #1A1A2E;
        --tab-bg: #0F0F1A;
        --tab-active-bg: #1A1A2E;
        --tab-active-text: #F9FAFB;
        --tab-inactive-text: #6B7280;
        --user-badge-bg: rgba(16,185,129,0.15);
        --user-badge-text: #34D399;
        --team-a-text: #A5B4FC;
        --team-a-score: #818CF8;
        --team-b-text: #FDA4AF;
        --team-b-score: #FB7185;
    }

    .s-bg { background-color: var(--bg-main); }
    .s-header { background-color: var(--header-bg); border-bottom: 1px solid var(--border); }
    .s-back { color: var(--text-secondary); }
    .s-back:hover { background-color: var(--bg-card-sub); }
    .s-title { color: var(--text-primary); }
    .s-card { background-color: var(--bg-card); border: 1px solid var(--border); }
    .s-card-sub { background-color: var(--bg-card-sub); }
    .s-text-primary { color: var(--text-primary); }
    .s-text-secondary { color: var(--text-secondary); }
    .s-text-muted { color: var(--text-muted); }
    .s-input { color: var(--input-text); background: transparent; }
    .s-error { background-color: var(--error-bg); color: var(--error-text); }
    .s-toggle-label { color: var(--toggle-label); }
    .s-toggle-sub { color: var(--toggle-sub); }
    .s-toggle-card { background-color: var(--toggle-card-bg); border: 1px solid var(--border); }
    .s-admin-icon { background-color: var(--admin-icon-bg); }
    .s-tab-bar { background-color: var(--tab-bg); }
    .s-tab-active { background-color: var(--tab-active-bg); color: var(--tab-active-text); }
    .s-tab-inactive { color: var(--tab-inactive-text); }
    .s-user-badge { background-color: var(--user-badge-bg); color: var(--user-badge-text); }
    .s-section-label { color: var(--text-muted); }
    .s-user-row { background-color: var(--bg-card); border: 1px solid var(--border); }
    .s-user-name { color: var(--text-primary); }
    .s-user-code { color: var(--text-muted); }
    .s-version { color: var(--text-muted); }
</style>

<div class="s-bg fixed inset-0 overflow-y-auto pb-20">
    <div class="max-w-md mx-auto relative">

        <div class="sticky top-0 z-40 s-header backdrop-blur-md px-4 py-3 flex items-center justify-between shadow-sm">
            <a href="/" class="w-10 h-10 flex items-center justify-center rounded-full transition active:scale-95 s-back">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            <h2 class="text-lg font-black tracking-tight s-title">ì„¤ì •</h2>
            <div class="w-10"></div>
        </div>

        <div class="px-5 pt-6">

            <div id="auth-required-section" class="s-card rounded-3xl shadow-lg p-8 text-center mt-10">
                <div class="text-6xl mb-4 animate-bounce">ğŸ”’</div>
                <h3 class="text-xl font-black mb-2 s-text-primary">ë¡œê·¸ì¸ì´ í•„ìš”í•´ìš”</h3>
                <p class="text-sm mb-8 leading-relaxed s-text-secondary">
                    ë³¸ì¸ í™•ì¸ì„ ìœ„í•´<br>ë°œê¸‰ë°›ì€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                </p>

                <!-- ë‹¤í¬ëª¨ë“œ í† ê¸€ -->
                <div class="s-toggle-card rounded-2xl shadow-sm p-4 flex items-center justify-between">
                    <div>
                        <p class="text-sm font-bold s-toggle-label">ë‹¤í¬ ëª¨ë“œ</p>
                        <p class="text-xs mt-0.5 s-toggle-sub">ì–´ë‘ìš´ í…Œë§ˆë¡œ ì „í™˜í•©ë‹ˆë‹¤</p>
                    </div>
                    <button class="theme-toggle-btn relative w-14 h-7 rounded-full transition-colors duration-300 focus:outline-none" onclick="toggleTheme()" class="relative w-14 h-7 rounded-full transition-colors duration-300 focus:outline-none" aria-label="í…Œë§ˆ ì „í™˜">
                        <div class="theme-toggle-track w-full h-full rounded-full transition-colors duration-300 bg-gray-200" class="w-full h-full rounded-full transition-colors duration-300 bg-gray-200"></div>
                        <div class="theme-toggle-thumb absolute top-0.5 left-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-transform duration-300" class="absolute top-0.5 left-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-transform duration-300"></div>
                    </button>
                </div>
                <button
                    onclick="requestAuth()"
                    class="w-full mt-4 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg transition transform active:scale-95"
                >
                    ì½”ë“œ ì…ë ¥í•˜ê¸°
                </button>
            </div>

            <div id="user-settings-section" class="hidden">
                <div class="flex flex-col items-center mb-8">
                    <div class="relative group">
                        <div class="w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-lg mb-4 bg-gray-100">
                            <img id="user-profile-img" src="https://via.placeholder.com/80" alt="í”„ë¡œí•„" class="w-full h-full object-cover" style="object-fit: cover; object-position: center;">
                        </div>
                        <button onclick="showProfileImageMenu()" class="absolute bottom-4 right-0 bg-gray-900 text-white p-1.5 rounded-full shadow-md hover:bg-black transition active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        </button>
                    </div>
                    <p id="user-profile-name" class="text-2xl font-black mb-1 s-text-primary"></p>
                    <span class="text-xs font-bold px-2 py-1 rounded-md s-user-badge">User</span>
                </div>

                <input type="file" id="profile-image-input" accept="image/jpeg,image/jpg,image/png,image/webp" class="hidden" onchange="handleImageSelect(event)">

                <div class="space-y-4 mb-8">
                    <div class="s-card p-4 rounded-2xl shadow-sm">
                        <label class="block text-xs font-bold mb-1 uppercase tracking-wider s-text-muted">ë‹‰ë„¤ì„</label>
                        <input
                            type="text"
                            id="edit-name"
                            class="w-full text-lg font-bold bg-transparent border-none focus:ring-0 p-0 placeholder-gray-300 s-input"
                            placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                            maxlength="50"
                        >
                    </div>

                    <div class="s-card p-4 rounded-2xl shadow-sm">
                        <label class="block text-xs font-bold mb-1 uppercase tracking-wider s-text-muted">ì ‘ì† ì½”ë“œ</label>
                        <div class="flex items-center">
                            <input
                                type="password"
                                id="edit-code"
                                class="w-full text-lg font-bold bg-transparent border-none focus:ring-0 p-0 placeholder-gray-300 s-input"
                                placeholder="ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                maxlength="50"
                            >
                            <button type="button" onclick="toggleCodeVisibility()" class="p-2 s-text-muted">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <p class="text-[10px] pl-2 s-text-muted">âš ï¸ ì½”ë“œëŠ” ë„ì–´ì“°ê¸° ì—†ì´ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                </div>

                <div id="edit-error-message" class="hidden s-error px-4 py-3 rounded-xl mb-6 text-sm font-bold text-center"></div>

                <div class="space-y-3">

                <!-- ë‹¤í¬ëª¨ë“œ í† ê¸€ -->
                <div class="s-toggle-card rounded-2xl shadow-sm p-4 flex items-center justify-between">
                    <div>
                        <p class="text-sm font-bold s-toggle-label">ë‹¤í¬ ëª¨ë“œ</p>
                        <p class="text-xs mt-0.5 s-toggle-sub">ì–´ë‘ìš´ í…Œë§ˆë¡œ ì „í™˜í•©ë‹ˆë‹¤</p>
                    </div>
                    <button class="theme-toggle-btn relative w-14 h-7 rounded-full transition-colors duration-300 focus:outline-none" onclick="toggleTheme()" aria-label="í…Œë§ˆ ì „í™˜">
                        <div class="theme-toggle-track w-full h-full rounded-full transition-colors duration-300 bg-gray-200"></div>
                        <div class="theme-toggle-thumb absolute top-0.5 left-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-transform duration-300"></div>
                    </button>
                </div>
                    <button onclick="saveProfile()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 rounded-2xl transition active:scale-[0.98]">ì €ì¥í•˜ê¸°</button>
                    <button onclick="logout()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-4 rounded-2xl transition active:scale-[0.98]">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>

            <div id="admin-settings-section" class="hidden">
                <div class="flex flex-col items-center mb-6">
                    <div class="w-20 h-20 rounded-full flex items-center justify-center mb-3 shadow-lg s-admin-icon">
                        <span class="text-3xl">ğŸ› ï¸</span>
                    </div>
                    <h3 class="text-xl font-black s-text-primary">ê´€ë¦¬ì ëª¨ë“œ</h3>
                </div>

                <div class="s-tab-bar p-1 rounded-xl flex mb-6">
                    <button id="tab-users" onclick="switchAdminTab('users')" class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all shadow-sm bg-white text-gray-800">ìœ ì € ê´€ë¦¬</button>
                    <button id="tab-data" onclick="switchAdminTab('data')" class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all text-gray-400 hover:text-gray-600">ë°ì´í„° ê´€ë¦¬</button>
                </div>

                <div id="admin-users-tab" class="space-y-3 pb-20">
                    <h3 class="text-xs font-bold uppercase mb-2 px-1 s-section-label">ë“±ë¡ëœ ìœ ì €</h3>
                    <div id="admin-users-list" class="space-y-3"></div>
                </div>

                <div id="admin-data-tab" class="hidden space-y-3 pb-20">
                    <h3 class="text-xs font-bold uppercase mb-2 px-1 s-section-label">ì‹œìŠ¤í…œ ê´€ë¦¬</h3>
                    <button onclick="showMatchEditModal()" class="w-full flex items-center justify-between p-5 s-card rounded-2xl shadow-sm transition active:scale-95" style="hover:background-color:var(--bg-card-sub)">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color:var(--bg-card-sub)">âœï¸</div>
                            <span class="font-bold s-text-primary">ì˜ëª»ëœ ê¸°ë¡ ìˆ˜ì •</span>
                        </div>
                        <span class="s-text-muted">â†’</span>
                    </button>
                    <h3 class="text-xs font-bold uppercase mt-4 mb-2 px-1 s-section-label">ë°ì´í„° ì´ˆê¸°í™”</h3>
                    <button onclick="openResetModal('players')" class="w-full flex items-center justify-between p-5 s-card rounded-2xl shadow-sm transition active:scale-95">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color:rgba(239,68,68,0.08)">ğŸ‘¤</div>
                            <span class="font-bold s-text-primary">í”Œë ˆì´ì–´ ì´ˆê¸°í™”</span>
                        </div>
                        <span class="s-text-muted">â†’</span>
                    </button>
                    <button onclick="openResetModal('matches')" class="w-full flex items-center justify-between p-5 s-card rounded-2xl shadow-sm transition active:scale-95">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color:rgba(239,68,68,0.08)">ğŸ®</div>
                            <span class="font-bold s-text-primary">ë§¤ì¹˜ ì´ˆê¸°í™”</span>
                        </div>
                        <span class="s-text-muted">â†’</span>
                    </button>
                    <button onclick="openResetModal('stats')" class="w-full flex items-center justify-between p-5 s-card rounded-2xl shadow-sm transition active:scale-95">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color:rgba(239,68,68,0.08)">ğŸ“Š</div>
                            <span class="font-bold s-text-primary">í†µê³„ ì´ˆê¸°í™”</span>
                        </div>
                        <span class="s-text-muted">â†’</span>
                    </button>
                    <button onclick="openResetModal('all')" class="w-full flex items-center justify-between p-5 bg-white border border-red-100 rounded-2xl shadow-sm hover:bg-red-50 transition active:scale-95 group">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center text-red-500 group-hover:bg-red-100">ğŸ—‘ï¸</div>
                            <span class="font-bold text-red-500">ì „ì²´ ì´ˆê¸°í™”</span>
                        </div>
                        <span class="text-red-300 group-hover:text-red-500">â†’</span>
                    </button>
                </div>


                <!-- ë‹¤í¬ëª¨ë“œ í† ê¸€ -->
                <div class="s-toggle-card rounded-2xl shadow-sm p-4 flex items-center justify-between">
                    <div>
                        <p class="text-sm font-bold s-toggle-label">ë‹¤í¬ ëª¨ë“œ</p>
                        <p class="text-xs mt-0.5 s-toggle-sub">ì–´ë‘ìš´ í…Œë§ˆë¡œ ì „í™˜í•©ë‹ˆë‹¤</p>
                    </div>
                    <button class="theme-toggle-btn relative w-14 h-7 rounded-full transition-colors duration-300 focus:outline-none" onclick="toggleTheme()" class="relative w-14 h-7 rounded-full transition-colors duration-300 focus:outline-none" aria-label="í…Œë§ˆ ì „í™˜">
                        <div class="theme-toggle-track w-full h-full rounded-full transition-colors duration-300 bg-gray-200" class="w-full h-full rounded-full transition-colors duration-300 bg-gray-200"></div>
                        <div class="theme-toggle-thumb absolute top-0.5 left-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-transform duration-300" class="absolute top-0.5 left-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-transform duration-300"></div>
                    </button>
                </div>
                <button onclick="logout()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-4 rounded-2xl transition active:scale-[0.98] mt-4">ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div class="text-center mt-8 pb-8">
                <p class="text-[10px] font-bold uppercase tracking-widest s-version">Tichu Manager v1.0.0</p>
            </div>
        </div>
    </div>
</div>

<!-- í”„ë¡œí•„ ì´ë¯¸ì§€ ì„ íƒ ë©”ë‰´ ëª¨ë‹¬ -->
<div id="profile-menu-modal" class="hidden fixed inset-0 z-50 flex items-end justify-center bg-black/60 backdrop-blur-sm" onclick="closeProfileImageMenu()">
    <div class="bg-white rounded-t-3xl w-full max-w-md shadow-2xl animate-slide-up" onclick="event.stopPropagation()">
        <div class="p-6 space-y-3">
            <button onclick="openFileSelector()" class="w-full flex items-center justify-center gap-3 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 rounded-2xl transition active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span>ì‚¬ì§„ ë³€ê²½</span>
            </button>
            <button onclick="resetToDefaultImage()" class="w-full flex items-center justify-center gap-3 bg-gray-500 hover:bg-gray-600 text-white font-bold py-4 rounded-2xl transition active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span>ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ</span>
            </button>
            <button onclick="closeProfileImageMenu()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 rounded-2xl transition active:scale-95">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<!-- ê¸°ë¡ ìˆ˜ì • ë§¤ì¹˜ ëª©ë¡ ëª¨ë‹¬ -->
<div id="match-edit-modal" class="hidden fixed inset-0 z-50 flex flex-col justify-end bg-black/60 backdrop-blur-sm" onclick="closeMatchEditModal()">
    <div class="w-full max-w-md mx-auto rounded-t-3xl shadow-2xl animate-slide-up flex flex-col h-full" style="background-color:var(--bg-card);" onclick="event.stopPropagation()">
        <div class="p-5 border-b flex items-center justify-between shrink-0" style="border-color:var(--border)">
            <div class="w-9"></div>
            <h3 class="text-lg font-black s-text-primary">ê¸°ë¡ ìˆ˜ì •</h3>
            <button onclick="closeMatchEditModal()" class="p-2 s-text-muted">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="match-edit-list" class="p-4 space-y-3 overflow-y-auto flex-1"></div>
    </div>
</div>

<!-- ë°ì´í„° ì´ˆê¸°í™” ì‹œì¦Œ ì„ íƒ ëª¨ë‹¬ -->
<div id="reset-modal" class="hidden fixed inset-0 z-50 flex items-end justify-center bg-black/60 backdrop-blur-sm" onclick="closeResetModal()">
    <div class="w-full max-w-md mx-auto rounded-t-3xl shadow-2xl animate-slide-up" style="background-color:var(--bg-card);" onclick="event.stopPropagation()">
        <div class="p-5 border-b flex items-center justify-between" style="border-color:var(--border)">
            <div class="w-9"></div>
            <h3 id="reset-modal-title" class="text-lg font-black s-text-primary">ë°ì´í„° ì´ˆê¸°í™”</h3>
            <button onclick="closeResetModal()" class="p-2 s-text-muted">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="p-5">
            <p class="text-sm mb-4 s-text-secondary">ì‚­ì œí•  ì‹œì¦Œì„ ì„ íƒí•˜ì„¸ìš”.</p>
            <div id="reset-year-buttons" class="space-y-3"></div>
        </div>
    </div>
</div>

<style>
    @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .animate-slide-up { animation: slide-up 0.3s ease-out forwards; }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentPlayerId = null;

    document.addEventListener('DOMContentLoaded', () => {
        checkAuthAndLoadSettings();
        initThemeToggle();

        const codeInput = document.getElementById('edit-code');
        if (codeInput) AuthManager.preventSpace(codeInput);
    });

    // â”€â”€ í”„ë¡œí•„ ì´ë¯¸ì§€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showProfileImageMenu() { document.getElementById('profile-menu-modal').classList.remove('hidden'); }
    function closeProfileImageMenu() { document.getElementById('profile-menu-modal').classList.add('hidden'); }
    function openFileSelector() { closeProfileImageMenu(); document.getElementById('profile-image-input').click(); }

    async function resetToDefaultImage() {
        closeProfileImageMenu();
        if (!confirm('í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            const response = await fetch(`/api/players/${currentPlayerId}/reset-profile`, { method: 'POST' });
            if (!response.ok) throw new Error((await response.json()).detail || 'ì´ˆê¸°í™” ì‹¤íŒ¨');
            const result = await response.json();
            document.getElementById('user-profile-img').src = result.profile_url;
            alert('ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) { alert('ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
    }

    async function handleImageSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) { alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
        if (file.size > 5 * 1024 * 1024) { alert('íŒŒì¼ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
        try {
            const resizedBlob = await resizeImage(file, 500, 500);
            document.getElementById('user-profile-img').src = URL.createObjectURL(resizedBlob);
            await uploadProfileImage(resizedBlob);
        } catch (error) { alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
    }

    function resizeImage(file, maxWidth, maxHeight) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    let width = img.width, height = img.height;
                    if (width > height) { if (width > maxWidth) { height = height * maxWidth / width; width = maxWidth; } }
                    else { if (height > maxHeight) { width = width * maxHeight / height; height = maxHeight; } }
                    const size = Math.min(width, height);
                    const canvas = document.createElement('canvas');
                    canvas.width = size; canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, (width-size)/2, (height-size)/2, size, size, 0, 0, size, size);
                    canvas.toBlob(resolve, 'image/jpeg', 0.8);
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function uploadProfileImage(blob) {
        const formData = new FormData();
        formData.append('file', blob, 'profile.jpg');
        const response = await fetch(`/api/players/${currentPlayerId}/upload-profile`, { method: 'POST', body: formData });
        if (!response.ok) throw new Error((await response.json()).detail || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
        const result = await response.json();
        document.getElementById('user-profile-img').src = result.profile_url;
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€ í…Œë§ˆ í† ê¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function initThemeToggle() {
        const theme = localStorage.getItem('tichu_theme') || 'light';
        applyToggleUI(theme);
    }

    function toggleTheme() {
        const current = localStorage.getItem('tichu_theme') || 'light';
        const next = current === 'light' ? 'dark' : 'light';
        localStorage.setItem('tichu_theme', next);
        document.documentElement.setAttribute('data-theme', next);
        applyToggleUI(next);
    }

    function applyToggleUI(theme) {
        document.querySelectorAll('.theme-toggle-track').forEach(track => {
            track.style.backgroundColor = theme === 'dark' ? '#4F46E5' : '#D1D5DB';
        });
        document.querySelectorAll('.theme-toggle-thumb').forEach(thumb => {
            thumb.style.transform = theme === 'dark' ? 'translateX(1.75rem)' : 'translateX(0)';
        });
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function checkAuthAndLoadSettings() {
        const auth = AuthManager.getAuth();
        if (!auth) {
            showAuthRequired();
        } else if (auth.role === 'admin') {
            showAdminSettings();
        } else {
            currentPlayerId = auth.playerId;
            showUserSettings(auth.playerId);
        }
    }

    function showAuthRequired() {
        document.getElementById('auth-required-section').classList.remove('hidden');
        document.getElementById('user-settings-section').classList.add('hidden');
        document.getElementById('admin-settings-section').classList.add('hidden');
    }

    function requestAuth() {
        AuthManager.showAuthModal((data) => { checkAuthAndLoadSettings(); });
    }

    async function showUserSettings(playerId) {
        document.getElementById('auth-required-section').classList.add('hidden');
        document.getElementById('user-settings-section').classList.remove('hidden');
        document.getElementById('admin-settings-section').classList.add('hidden');
        try {
            const response = await fetch(`/api/players/${playerId}`);
            const player = await response.json();
            document.getElementById('user-profile-img').src = player.profile_url;
            document.getElementById('user-profile-name').textContent = player.name;
            document.getElementById('edit-name').value = player.name;
            document.getElementById('edit-code').value = player.code;
        } catch (error) { console.error('ìœ ì € ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error); }
    }

    function showAdminSettings() {
        document.getElementById('auth-required-section').classList.add('hidden');
        document.getElementById('user-settings-section').classList.add('hidden');
        document.getElementById('admin-settings-section').classList.remove('hidden');
        switchAdminTab('users');
    }

    function switchAdminTab(tab) {
        const usersTabBtn = document.getElementById('tab-users');
        const dataTabBtn = document.getElementById('tab-data');
        const activeStyle = ['bg-white', 'text-gray-800', 'shadow-sm'];

        if (tab === 'users') {
            usersTabBtn.classList.add(...activeStyle);
            usersTabBtn.classList.remove('text-gray-400', 'hover:text-gray-600');
            dataTabBtn.classList.remove(...activeStyle);
            dataTabBtn.classList.add('text-gray-400', 'hover:text-gray-600');
            document.getElementById('admin-users-tab').classList.remove('hidden');
            document.getElementById('admin-data-tab').classList.add('hidden');
            loadAllUsers();
        } else {
            dataTabBtn.classList.add(...activeStyle);
            dataTabBtn.classList.remove('text-gray-400', 'hover:text-gray-600');
            usersTabBtn.classList.remove(...activeStyle);
            usersTabBtn.classList.add('text-gray-400', 'hover:text-gray-600');
            document.getElementById('admin-users-tab').classList.add('hidden');
            document.getElementById('admin-data-tab').classList.remove('hidden');
        }
    }

    async function loadAllUsers() {
        try {
            const adminCode = AuthManager.getAdminCode();
            const response = await fetch('/api/admin/users', { headers: { 'Authorization': adminCode } });
            if (!response.ok) throw new Error('ìœ ì € ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
            const players = await response.json();
            const usersList = document.getElementById('admin-users-list');
            usersList.innerHTML = '';
            if (players.length === 0) {
                usersList.innerHTML = '<p class="text-center text-gray-400 py-10 text-sm">ë“±ë¡ëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            players.forEach(player => {
                const div = document.createElement('div');
                div.className = 's-user-row flex items-center justify-between p-4 rounded-2xl shadow-sm';
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <img src="${player.profile_url}" alt="${player.name}" class="w-12 h-12 rounded-full object-cover" style="background-color: var(--bg-card-sub);">
                        <div>
                            <p class="font-bold text-base s-user-name">${player.name}</p>
                            <p class="text-xs font-mono s-user-code">CODE: ${player.code}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="deleteUser(${player.id}, '${player.name}')" class="bg-red-50 text-red-500 hover:bg-red-100 hover:text-red-600 px-4 py-2 rounded-xl text-xs font-bold transition">ì‚­ì œ</button>
                    </div>
                `;
                usersList.appendChild(div);
            });
        } catch (error) {
            console.error('ìœ ì € ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('ìœ ì € ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function toggleCodeVisibility() {
        const input = document.getElementById('edit-code');
        input.type = input.type === 'password' ? 'text' : 'password';
    }

    async function saveProfile() {
        const name = document.getElementById('edit-name').value.trim();
        const code = document.getElementById('edit-code').value;
        const errorDiv = document.getElementById('edit-error-message');
        if (!name) { errorDiv.textContent = 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'; errorDiv.classList.remove('hidden'); return; }
        if (!code) { errorDiv.textContent = 'ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'; errorDiv.classList.remove('hidden'); return; }
        if (/\s/.test(code)) { errorDiv.textContent = 'ì½”ë“œì—ëŠ” ê³µë°±ì„ í¬í•¨í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; errorDiv.classList.remove('hidden'); return; }
        try {
            const response = await fetch(`/api/players/${currentPlayerId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, code })
            });
            if (!response.ok) {
                const error = await response.json();
                errorDiv.textContent = error.detail || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                errorDiv.classList.remove('hidden');
                return;
            }
            errorDiv.classList.add('hidden');
            alert('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch (error) {
            errorDiv.textContent = 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            errorDiv.classList.remove('hidden');
        }
    }

    async function deleteUser(playerId, playerName) {
        if (!confirm(`ì •ë§ ${playerName}ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë ¨ëœ ëª¨ë“  ê²Œì„ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
        try {
            const adminCode = AuthManager.getAdminCode();
            const response = await fetch(`/api/admin/users/${playerId}`, { method: 'DELETE', headers: { 'Authorization': adminCode } });
            if (!response.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
            alert(`${playerName}ë‹˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            loadAllUsers();
        } catch (error) {
            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // â”€â”€ ë°ì´í„° ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let resetTarget = null;
    const RESET_LABELS = { players: 'í”Œë ˆì´ì–´', matches: 'ë§¤ì¹˜', stats: 'í†µê³„', all: 'ì „ì²´' };
    const START_YEAR = 2026;

    function openResetModal(target) {
        if (target === 'players') {
            confirmReset('players', null);
            return;
        }
        resetTarget = target;
        document.getElementById('reset-modal-title').textContent = `${RESET_LABELS[target]} ì´ˆê¸°í™”`;
        const container = document.getElementById('reset-year-buttons');
        container.innerHTML = '';
        const currentYear = new Date().getFullYear();
        for (let y = currentYear; y >= START_YEAR; y--) {
            const btn = document.createElement('button');
            btn.className = 'w-full p-4 rounded-2xl font-bold text-sm transition active:scale-95 s-card';
            btn.style.color = 'var(--text-primary)';
            btn.textContent = `${y}ë…„ ì‹œì¦Œ`;
            btn.onclick = () => confirmReset(target, y);
            container.appendChild(btn);
        }
        const allBtn = document.createElement('button');
        allBtn.className = 'w-full p-4 rounded-2xl font-bold text-sm transition active:scale-95 border border-red-200 hover:bg-red-50';
        allBtn.style.color = '#EF4444';
        allBtn.textContent = 'ì „ì²´ ë°ì´í„°';
        allBtn.onclick = () => confirmReset(target, null);
        container.appendChild(allBtn);
        document.getElementById('reset-modal').classList.remove('hidden');
    }

    function closeResetModal() { document.getElementById('reset-modal').classList.add('hidden'); }

    async function confirmReset(table, year) {
        const label = RESET_LABELS[table];
        const yearLabel = year ? `${year}ë…„` : 'ì „ì²´';
        if (!confirm(`âš ï¸ ${label} ${yearLabel} ë°ì´í„°ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        if (!confirm(`ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) return;
        try {
            const adminCode = AuthManager.getAdminCode();
            const body = { table, year };
            const response = await fetch('/api/admin/reset', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json', 'Authorization': adminCode },
                body: JSON.stringify(body)
            });
            if (!response.ok) throw new Error((await response.json()).detail || 'ì´ˆê¸°í™” ì‹¤íŒ¨');
            const result = await response.json();
            alert(result.message);
            closeResetModal();
            if (table === 'all' && !year) { AuthManager.logout(); window.location.href = '/'; }
        } catch (error) {
            alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€ ê¸°ë¡ ìˆ˜ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function showMatchEditModal() {
        const modal = document.getElementById('match-edit-modal');
        const inner = modal.querySelector('.animate-slide-up');
        inner.style.transform = 'translateY(100%)';
        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
            inner.style.transition = 'transform 0.3s ease-out';
            inner.style.transform = 'translateY(0)';
        });
        const list = document.getElementById('match-edit-list');
        list.innerHTML = '<p class="text-center py-8 s-text-muted text-sm">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
        try {
            const response = await fetch('/api/matches/finished?limit=10');
            if (!response.ok) throw new Error('ë§¤ì¹˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
            const matches = await response.json();
            list.innerHTML = '';
            if (matches.length === 0) {
                list.innerHTML = '<p class="text-center py-8 s-text-muted text-sm">ì™„ë£Œëœ ê²Œì„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            matches.forEach(match => {
                const isWinnerA = match.winner_team === 'A';
                const div = document.createElement('a');
                div.href = `/scoreboard/${match.id}`;
                div.className = 's-user-row flex flex-col p-4 rounded-2xl shadow-sm active:scale-95 transition block';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-bold s-text-muted">${match.play_date}</span>
                        <span class="text-xs font-bold px-2 py-0.5 rounded-full ${isWinnerA ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-600'}">
                            ${isWinnerA ? 'TEAM A' : 'TEAM B'} ìŠ¹ë¦¬
                        </span>
                    </div>
                    <div class="flex items-center justify-between gap-2">
                        <div class="flex-1">
                            <p class="text-xs font-bold mb-0.5" style="color:var(--team-a-text)">TEAM A</p>
                            <p class="text-sm font-bold s-text-primary">${match.team_a_names.join(', ')}</p>
                        </div>
                        <p class="text-2xl font-black shrink-0" style="color:var(--team-a-score)">${match.score_a}</p>
                        <p class="text-sm font-bold s-text-muted shrink-0">vs</p>
                        <p class="text-2xl font-black shrink-0" style="color:var(--team-b-score)">${match.score_b}</p>
                        <div class="flex-1 text-right">
                            <p class="text-xs font-bold mb-0.5" style="color:var(--team-b-text)">TEAM B</p>
                            <p class="text-sm font-bold s-text-primary">${match.team_b_names.join(', ')}</p>
                        </div>
                    </div>`;
                list.appendChild(div);
            });
        } catch (error) {
            list.innerHTML = '<p class="text-center py-8 text-red-500 text-sm">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }
    function closeMatchEditModal() { document.getElementById('match-edit-modal').classList.add('hidden'); }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function logout() {
        AuthManager.logout();
        window.location.href = '/';
    }
</script>
{% endblock %}